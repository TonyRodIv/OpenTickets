<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Escolher Assentos e Tipos de Ingresso</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Estilos básicos para o mapa de assentos */
        .screen {
            background-color: #333;
            height: 50px;
            width: 80%;
            margin: 20px auto;
            border-radius: 5px;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .seat-map-container {
            overflow-x: auto; /* Para salas muito largas */
            padding-bottom: 10px; /* Espaço para a barra de rolagem */
        }
        .seat-map {
            display: inline-grid; /* Para que o grid se ajuste ao conteúdo e permita rolagem horizontal */
            /* Isso vai ser definido via JS para ter o número correto de colunas */
            grid-template-columns: repeat(var(--num-colunas, 10), 40px); /* Padrão 10, pode ser atualizado via JS */
            gap: 10px;
            justify-content: center;
            margin: 30px auto; /* Centraliza o mapa */
            border: 1px solid #ccc; /* Só para visualização */
            padding: 10px;
        }
        .seat-row {
            display: contents; /* Faz com que os filhos sejam colocados diretamente no grid do pai */
        }
        .seat {
            width: 40px;
            height: 40px;
            background-color: #4CAF50; /* Assento livre */
            border: 1px solid #388E3C;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            font-size: 0.9em;
            transition: background-color 0.2s ease; /* Transição suave */
        }
        .seat.occupied {
            background-color: #f44336; /* Assento ocupado */
            border: 1px solid #d32f2f;
            cursor: not-allowed;
        }
        .seat.selected {
            background-color: #2196F3; /* Assento selecionado */
            border: 1px solid #1976D2;
        }

        /* Área de seleção de ingressos e total */
        .ticket-selection-area {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .ticket-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #eee;
            border-radius: 5px;
        }
        .ticket-item span {
            font-weight: bold;
            color: #555;
        }
        .ticket-item select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .total-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            text-align: right;
        }
        .total-info h4 {
            margin: 0;
            color: #0056b3;
        }
        .total-info p {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div>
        <h3>Selecione os Assentos</h3>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <p>Filme: <strong>{{ filme.titulo }}</strong> | Sala: <strong>{{ sala_num }}</strong></p>

        <div class="screen">TELA</div>

        <form method="POST" id="form-venda">
            <div class="seat-map-container">
                <div class="seat-map" id="seat-map" 
                     style="--num-colunas: {{ sala_obj.colunas if sala_obj else 10 }};"> {# Define a variável CSS aqui #}
                    {# O mapa de assentos será renderizado aqui pelo Flask #}
                    {% for row_seats in mapa %}
                        <div class="seat-row">
                            {% for assento_code in row_seats %}
                                {% if assento_code == 'XX' %}
                                    <div class="seat occupied" data-assento-code="{{ assento_code }}">X</div>
                                {% else %}
                                    <div class="seat" data-assento-code="{{ assento_code }}">{{ assento_code }}</div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="ticket-selection-area">
                <h4>Tipos de Ingresso e Preço Total</h4>
                <div id="selected-tickets-list">
                    {# Assentos selecionados e seus tipos de ingresso serão adicionados aqui via JS #}
                    <p>Nenhum assento selecionado ainda. Clique nos assentos no mapa!</p>
                </div>

                <div class="total-info">
                    <h4>Total da Compra:</h4>
                    <p id="total-price">R$ 0,00</p>
                </div>
            </div>

            {# Inputs hidden para enviar os dados. Serão preenchidos pelo JS #}
            {# Ex: <input type="hidden" name="assentos_comprados[A1]" value="inteira"> #}
            <div id="hidden-inputs-container"></div>

            <button type="submit" style="margin-top: 20px;">Finalizar Compra</button>
        </form>
        <p><a href="{{ url_for('vend.escolher_sala') }}">← Voltar para Escolher Sala</a></p>
    </div>

    <script>
        const seatMap = document.getElementById('seat-map');
        const selectedTicketsList = document.getElementById('selected-tickets-list');
        const totalPriceDisplay = document.getElementById('total-price');
        const formVenda = document.getElementById('form-venda');
        const hiddenInputsContainer = document.getElementById('hidden-inputs-container');

        const PRICES = {
            'inteira': 25.00,
            'meia': 12.50
        };

        // Objeto para armazenar os assentos selecionados e seus tipos de ingresso
        // Ex: { 'A1': { type: 'inteira', element: null }, 'B2': { type: 'meia', element: null } }
        let selectedSeats = {}; 

        function updateTicketListAndTotalPrice() {
            // Limpa a lista atual
            selectedTicketsList.innerHTML = '';
            hiddenInputsContainer.innerHTML = ''; // Limpa os inputs hidden antigos

            let total = 0;
            const seatCodes = Object.keys(selectedSeats).sort((a, b) => {
                // Ordena assentos: A1, A2, B1, B2...
                const rowA = a.charCodeAt(0);
                const rowB = b.charCodeAt(0);
                if (rowA !== rowB) return rowA - rowB;
                return parseInt(a.substring(1)) - parseInt(b.substring(1));
            });

            if (seatCodes.length === 0) {
                selectedTicketsList.innerHTML = '<p>Nenhum assento selecionado ainda. Clique nos assentos no mapa!</p>';
            } else {
                seatCodes.forEach(seatCode => {
                    const currentSeat = selectedSeats[seatCode];

                    const ticketItem = document.createElement('div');
                    ticketItem.classList.add('ticket-item');
                    ticketItem.innerHTML = `
                        <span>Assento: ${seatCode}</span>
                        <select class="ticket-type-select" data-assento-code="${seatCode}">
                            <option value="inteira" ${currentSeat.type === 'inteira' ? 'selected' : ''}>Inteira (R$ ${PRICES['inteira'].toFixed(2).replace('.', ',')})</option>
                            <option value="meia" ${currentSeat.type === 'meia' ? 'selected' : ''}>Meia (R$ ${PRICES['meia'].toFixed(2).replace('.', ',')})</option>
                        </select>
                    `;
                    selectedTicketsList.appendChild(ticketItem);

                    // Adiciona o input hidden para envio ao backend
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `assentos_comprados[${seatCode}]`;
                    hiddenInput.value = currentSeat.type;
                    hiddenInputsContainer.appendChild(hiddenInput);

                    total += PRICES[currentSeat.type];
                });
            }
            totalPriceDisplay.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // Evento de clique no mapa de assentos
        seatMap.addEventListener('click', function(event) {
            const clickedSeat = event.target.closest('.seat');

            if (clickedSeat && !clickedSeat.classList.contains('occupied')) {
                const assentoCode = clickedSeat.dataset.assentoCode;

                if (clickedSeat.classList.contains('selected')) {
                    // Desselecionar assento
                    clickedSeat.classList.remove('selected');
                    delete selectedSeats[assentoCode];
                } else {
                    // Selecionar assento (padrão como inteira)
                    clickedSeat.classList.add('selected');
                    selectedSeats[assentoCode] = { type: 'inteira' }; // Default para 'inteira'
                }
                updateTicketListAndTotalPrice();
            }
        });

        // Evento de mudança nos selects de tipo de ingresso
        selectedTicketsList.addEventListener('change', function(event) {
            const target = event.target;
            if (target.classList.contains('ticket-type-select')) {
                const assentoCode = target.dataset.assentoCode;
                selectedSeats[assentoCode].type = target.value;
                updateTicketListAndTotalPrice();
            }
        });

        // Chamada inicial para preencher o mapa de assentos (se houver dados iniciais)
        updateTicketListAndTotalPrice();
    </script>
</body>
</html>